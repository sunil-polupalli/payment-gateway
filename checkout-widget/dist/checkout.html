<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">  <title>Secure Checkout</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>

    <div class="card">
        <div class="header">
            <div class="merchant-name">Test Merchant</div>
            <div class="amount">â‚¹500.00</div>
            <div style="font-size: 12px; color: #888; margin-top: 5px;">Order ID: <span id="order-id"></span></div>
        </div>

        <div class="payment-methods">
            <button class="method-btn active" onclick="selectMethod('upi')">UPI</button>
            <button class="method-btn" onclick="selectMethod('card')">Card</button>
        </div>

        <div id="upi-form" class="input-group">
            <label>UPI ID / VPA</label>
            <input type="text" id="vpa" placeholder="username@upi" value="test@upi">
        </div>

        <div id="card-form" class="input-group" style="display: none;">
            <label>Card Number</label>
            <input type="text" placeholder="0000 0000 0000 0000">
            <div style="display: flex; gap: 10px; margin-top: 10px;">
                <input type="text" placeholder="MM/YY" style="width: 50%;">
                <input type="text" placeholder="CVV" style="width: 50%;">
            </div>
        </div>

        <button id="pay-btn" class="pay-btn" data-test-id="confirm-payment-button">
            <span id="btn-text">Pay Now</span>
            <div class="spinner" id="btn-spinner"></div>
        </button>

        <div class="secure-badge">
            ðŸ”’ Secured by AsyncGateway
        </div>
    </div>

    <script>
        const params = new URLSearchParams(window.location.search);
        document.getElementById('order-id').innerText = params.get('order_id');
        let currentMethod = 'upi';

        function selectMethod(method) {
            currentMethod = method;
            document.querySelectorAll('.method-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');

            if (method === 'upi') {
                document.getElementById('upi-form').style.display = 'block';
                document.getElementById('card-form').style.display = 'none';
            } else {
                document.getElementById('upi-form').style.display = 'none';
                document.getElementById('card-form').style.display = 'block';
            }
        }

        document.getElementById('pay-btn').onclick = async function() {
            const btn = document.getElementById('pay-btn');
            const spinner = document.getElementById('btn-spinner');
            const btnText = document.getElementById('btn-text');

            // Loading State
            btn.disabled = true;
            btnText.style.display = 'none';
            spinner.style.display = 'block';

            try {
                const response = await fetch('http://localhost:8000/api/v1/payments', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Api-Key': 'key_test_abc123',
                        'X-Api-Secret': 'secret_test_xyz789'
                    },
                    body: JSON.stringify({
                        order_id: params.get('order_id'),
                        amount: 50000,
                        currency: "INR",
                        method: currentMethod,
                        vpa: document.getElementById('vpa').value
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    // Success UI Feedback
                    btn.style.background = '#28a745';
                    btn.innerHTML = 'âœ“ Success';
                    
                    setTimeout(() => {
                        window.parent.postMessage({
                            type: 'payment_success',
                            data: { paymentId: data.id }
                        }, '*');
                    }, 1000);
                } else {
                    // Error UI Feedback
                    throw new Error(data.error || 'Payment Failed');
                }
            } catch (error) {
                btn.style.background = '#dc3545';
                btn.innerHTML = 'âœ• Failed';
                setTimeout(() => {
                    window.parent.postMessage({
                        type: 'payment_failed',
                        data: error
                    }, '*');
                }, 1000);
            }
        };
    </script>
</body>
</html>